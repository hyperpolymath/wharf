# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Jonathan D. A. Jewell <hyperpolymath>
#
# WordPress-Specific Nginx Rules for Project Wharf
# =================================================
# This configuration implements the "Dark Matter" principle:
# /wp-admin exists on disk but is invisible to the public internet.
# Only requests through the Nebula mesh can reach admin endpoints.

server {
    listen 8080 default_server;
    listen [::]:8080 default_server;

    server_name _;
    root /var/www/html;
    index index.php index.html;

    # ==========================================================================
    # HEALTH CHECK ENDPOINT (For container orchestration)
    # ==========================================================================
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ==========================================================================
    # SECURITY: Block sensitive files
    # ==========================================================================

    # Block access to hidden files (except .well-known)
    location ~ /\.(?!well-known) {
        deny all;
        return 404;
    }

    # Block access to sensitive WordPress files
    location ~* /(wp-config\.php|readme\.html|license\.txt|xmlrpc\.php) {
        deny all;
        return 404;
    }

    # Block PHP execution in uploads directory (critical security measure)
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
        return 404;
    }

    # Block access to backup files
    location ~* \.(sql|bak|backup|old|orig|save|swp|tmp)$ {
        deny all;
        return 404;
    }

    # ==========================================================================
    # THE DARK MATTER: /wp-admin Lockdown
    # ==========================================================================
    # These paths exist on disk but are BLOCKED from the public internet.
    # The Rust Airlock allows access only from the Nebula mesh (10.x.x.x range).
    #
    # This is backup protection - the primary block is in the Yacht Agent.

    location /wp-admin {
        # Only allow from Nebula mesh IPs (configured by Wharf)
        # Default: deny all, allow only private mesh
        allow 10.0.0.0/8;      # Nebula mesh range
        allow 192.168.100.0/24; # Local Wharf subnet
        allow 127.0.0.1;        # Localhost (for agent)
        deny all;

        # If allowed, proxy to PHP
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass php-fpm;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_intercept_errors on;
        }
    }

    location /wp-login.php {
        # Rate limit login attempts (1 request per second max)
        limit_req zone=login burst=3 nodelay;

        # Same Nebula mesh restriction as wp-admin
        allow 10.0.0.0/8;
        allow 192.168.100.0/24;
        allow 127.0.0.1;
        deny all;

        include fastcgi_params;
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # ==========================================================================
    # WORDPRESS PRETTY PERMALINKS
    # ==========================================================================
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ==========================================================================
    # PHP HANDLING
    # ==========================================================================
    location ~ \.php$ {
        # Rate limit general PHP requests
        limit_req zone=general burst=20 nodelay;

        # Security: Only execute PHP files that exist
        try_files $uri =404;

        # FastCGI configuration
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        # Buffer settings
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;

        # Intercept errors for custom handling
        fastcgi_intercept_errors on;
    }

    # ==========================================================================
    # STATIC ASSETS (Aggressive caching)
    # ==========================================================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
        log_not_found off;
    }

    # ==========================================================================
    # WORDPRESS REST API (Selective access)
    # ==========================================================================
    location /wp-json/ {
        # Public read endpoints are allowed
        # Write endpoints require authentication (handled by WordPress)
        try_files $uri $uri/ /index.php?$args;
    }

    # ==========================================================================
    # ROBOTS.TXT
    # ==========================================================================
    location = /robots.txt {
        allow all;
        access_log off;
        log_not_found off;
    }

    # ==========================================================================
    # FAVICON
    # ==========================================================================
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }
}
